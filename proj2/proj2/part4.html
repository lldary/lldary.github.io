<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Part 4: Optimize a Program Segment Using Branch Optimization Techniques - Archlab gem5 Project 2</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Archlab gem5 Project 2</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="part-4-optimize-a-program-segment-using-branch-optimization-techniques"><a class="header" href="#part-4-optimize-a-program-segment-using-branch-optimization-techniques">Part 4: Optimize a Program Segment Using Branch Optimization Techniques</a></h1>
<p>It is well known that branch instructions cause pauses, significantly impacting program performance. To address this issue, hardware manufacturers have developed various branch predictors that reduce pauses by anticipating branches in advance. So, as software developers, can we further optimize program performance at the software level by understanding these branch predictors? The answer is yes.</p>
<p>In this experiment, we also hope students will gain an initial understanding of how branch optimization enhances program efficiency and appreciate its unique appeal. While compilers may already implement some optimization techniques, we still encourage students to delve into the principles behind these techniques through hands-on practice, thereby gaining a deeper understanding of the importance of branches in CPU architecture.</p>
<h2 id="lab-setup-preparation"><a class="header" href="#lab-setup-preparation">Lab Setup Preparation</a></h2>
<p>We need to obtain three files from <a href="https://disk.pku.edu.cn/link/AA8F735492EA4048A282AA5A7B9820B521">PKU Disk</a> or the <a href="https://course.pku.edu.cn/">teaching and learning network</a> for this part of the experiment. These files are <code>branch_optimize.c</code>, <code>branch_optimize_gen.cc</code>, and <code>branch_optimize.h</code>, which we will place in the <code>tests/labexe/</code>. The specific directory structure is shown in the diagram below:</p>
<pre><code class="language-sh">gem5-root
    |
    |---tests
          |
          |---labexe
                |
                |---branch_optimize.c
                |---branch_optimize_gen.cc
                |---branch_optimizze.h
</code></pre>
<p>At the same time, we need to modify the <code>tests/labexe/makefile</code> file to support the normal compilation of these newly added files:</p>
<pre><code class="language-makefile">...
# tests/labexe/makefile
# DELETE: TGT = shell_sort gemm binary_search spfa
TGT = shell_sort gemm binary_search spfa branch_optimize # ADD
...
lz77_args = 1000000
branch_optimize_args = 500000 # ADD
...
</code></pre>
<p>You can enter <code>make -j $(nproc)</code> to compile the target program after modifying it. The generated binary file will be located in <code>tests/labexe/branch_optimize</code>.</p>
<h2 id="our-goal"><a class="header" href="#our-goal">Our Goal</a></h2>
<p>In this part, we generated a fictional weather database, with each entry defined as follows:</p>
<pre><code class="language-c">typedef struct WeatherData {
    int year;
    int month;
    int day;
    int temperature;
    enum WeatherCondition condition;
    enum City city;
    float humidity;
    float windSpeed;
    int is_scanned;
} WeatherData;
</code></pre>
<p>The city and weather fields utilize enumeration types, defined as follows:</p>
<pre><code class="language-c">enum WeatherCondition {
    SUNNY = 0002,
    CLOUDY = 1009,
    RAINY = 1511,
    STORMY = 3011,
    SNOWY = 4003
};

enum City {
    NEW_YORK = 1,
    LOS_ANGELES = 2,
    CHICAGO = 3,
    HOUSTON = 4,
    MIAMI = 5
};
</code></pre>
<p>We need to optimize a target program for processing this weather data. The program's primary functions are:</p>
<ul>
<li>Exclude entries with outliers from all subsequent statistical calculations</li>
<li>Count the number of data entries for the period from 2012 to 2024</li>
<li>Count the number of data entries for the period from June to August</li>
<li>Count the number of data entries for each city</li>
<li>Count the frequency of occurrence for each type of weather</li>
<li>Count the frequency of occurrence for each wind force category, grouping those above force 10 into a single category</li>
<li>Record the minimum and maximum temperatures observed across all entries</li>
<li>Record the absolute maximum temperature value</li>
<li>Count the frequency of humidity levels below 50%</li>
<li>Count the frequency of temperatures exceeding 30 degrees Celsius</li>
<li>Mark the entry as scanned</li>
</ul>
<p>In <code>tests/labexe/branch_optimize.c</code>, we present a straightforward approach that does not achieve optimal performance. Students can optimize this performance by modifying the code in the designed area.</p>
<pre><code class="language-c">|        NO MODIFICATINS ALLOWED         |
/*   START position of editable area    */
|                 ...                    |
|            EDITABLE AREA               |
|                 ...                    |
/*    END position of editable area     */
|        NO MODIFICATINS ALLOWED         |
</code></pre>
<p>The following requirements apply during this process:</p>
<ul>
<li>Multithreading or multiprocessing is not permitted</li>
<li>No libraries import (via <code>#include</code>)</li>
<li>Parallel commands such as vectorization are prohibited</li>
<li><strong>NO loop unrolling technique</strong></li>
<li>The original program semantics must not be altered</li>
</ul>
<h2 id="test"><a class="header" href="#test">Test</a></h2>
<p>After modifying the code at the specified area, run the following command at <code>tests/labexe/branch_optimize</code> to compile the binary file:</p>
<pre><code class="language-sh">make -j $(nproc)
</code></pre>
<p>Next, you can execute the following command at <code>gem5/</code> to test the code's performance:</p>
<pre><code class="language-sh">build/ARM/gem5.opt configs/proj2/simple.py tests/labexe/branch_optimize --bp local --cpu o3 --mem DDR4 &amp;
</code></pre>
<p>You can evaluate the actual runtime of your code using the <code>simSounnds</code> in the <code>stat.txt</code> file output by <code>gem5</code>. Our performance evaluation is also based on this metric.</p>
<div id="admonition-delieverables" class="admonition admonish-example" role="note" aria-labelledby="admonition-delieverables-title">
<div class="admonition-title">
<div id="admonition-delieverables-title">
<p>Delieverables</p>
</div>
<a class="admonition-anchor-link" href="#admonition-delieverables"></a>
</div>
<div>
<p>Please run our target workloads, <code>branch_optimize</code>, with <code>LocalBP</code>. In this part, please (at least) include figures or tables, which show the actual runtime of <code>branch_optimize</code> and IPC of CPU on executables listed below, in your <em><strong>report</strong></em>:</p>
<ul>
<li>BPs: <code>LocalBP</code>.</li>
<li>exe: <code>branch_optimize</code>.</li>
<li>With default CPU and Memory (O3 and DDR4).</li>
</ul>
<p>In this part, you also need to submit:</p>
<ul>
<li><em><strong>your codes</strong></em>, including <code>branch_optimize.c</code>.</li>
<li><em><strong>technical introduction</strong></em>, which analyzes the optimization techniques used in your code and explain why they improve performance. (Unexplained code or techniques are permitted, but they should constitute <em><strong>less than 50%</strong></em> of the total.)</li>
</ul>
</div>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../proj2/part3.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../proj2/submit.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../proj2/part3.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../proj2/submit.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
