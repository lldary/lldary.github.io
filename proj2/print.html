<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Archlab gem5 Project 2</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="./mdbook-admonish.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Custom JS scripts for mdbook-pdf PDF generation -->
        <script type='text/javascript'>
            let markAllContentHasLoadedForPrinting = () =>
                window.setTimeout(
                    () => {
                        let p = document.createElement('div');
                        p.setAttribute('id', 'content-has-all-loaded-for-mdbook-pdf-generation');
                        document.body.appendChild(p);
                    }, 100
                );

            window.addEventListener('load', () => {
                // Expand all the <details> elements for printing.
                r = document.getElementsByTagName('details');
                for (let i of r)
                    i.open = true;

                try {
                    MathJax.Hub.Register.StartupHook('End', markAllContentHasLoadedForPrinting);
                } catch (e) {
                    markAllContentHasLoadedForPrinting();
                }
            });
        </script>
    <div style="display: none"><a href="#proj2">proj2</a><a href="#proj2-part1">proj2-part1</a><a href="#proj2-part2">proj2-part2</a><a href="#proj2-part3">proj2-part3</a><a href="#proj2-part4">proj2-part4</a><a href="#proj2-submit">proj2-submit</a><a href="#proj2-appendix">proj2-appendix</a></div>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Archlab gem5 Project 2</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="computer-architecture-2025fall-project-2"><a class="header" href="#computer-architecture-2025fall-project-2">Computer Architecture 2025fall Project 2</a></h1>
<div id="admonition-default" class="admonition admonish-success" role="note">
<div>
<p><em>By Prof. Jie Zhang</em></p>
<p><strong>Due:</strong> 11:59:59 pm, November 5, 2025</p>
</div>
</div>
<p>In this project, we will explore the design of a branch predictor (BP) in a computer system. Specifically, we will introduce how to add a branch predictor module in the configuration script. We also provide a tutorial to add a new branch predictor in <code>gem5</code>. You will evaluate how different types of branch predictors can impact the system performance. Further, you will try to implement various BPs by yourselves. Specifically, you will first implement a simple BP following the tutorial. Then, you are required to read a paper that first describes the perceptron BP. You need to summarize the paper and implement the perceptron BP. Next, you are required to compare your BP’s performance with other BPs that <code>gem5</code> has provided.</p>
<p>Whenever you face trouble or problems with this project, please refer contact TAs by WeChat or e-mail. All the following information has been verified on Ubuntu 20.04.1 with Linux Kernel 5.15.0 and Ubuntu 22.04.2 LTS with Linux Kernel 5.19.0.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="part-1-add-branch-predictor-in-the-configuration-script"><a class="header" href="#part-1-add-branch-predictor-in-the-configuration-script">Part 1: Add Branch Predictor in the Configuration Script</a></h1>
<p>In this part, we will extend our configuration script to enable the modification of CPU's branch predictor. Let's start with copying the original script to a new directory:</p>
<pre><code class="language-sh">mkdir -p configs/proj2
cp configs/proj1/simple.py configs/proj2
</code></pre>
<p>Then, let's change our default CPU to <code>O3CPU</code>. This is because <code>TimingSimpleCPU</code> assumes each instruction takes exactly a single CPU cycle, making it fail to reflect the impact of the branch predictor. The code can be modified as follows:</p>
<pre><code class="language-py">parser.add_argument(
    "--cpu",
    type=str,
    choices=list(cpu_types.keys()),
    # DELETE: default="simple",
    default="o3",
    help="CPU model to use",
)
</code></pre>
<p><code>gem5</code> provides different types of branch predictors. In this part, we will focus on three of them: local branch predictor, bi-mode branch predictor, and tournament branch predictor. Any one of these three branch predictors can be used to instantiate the CPU’s branch predictor object. In addition, you can configure each branch predictor with different configuration parameters. Let's add an option argument for modifying branch predictor:</p>
<pre><code class="language-py">bp_types = {
    "local": LocalBP,
    "bimode": BiModeBP,
    "tournament": TournamentBP,
}

def init_system(system, args):
    ...
    system.cpu.branchPred = bp_types[args.bp]()
    ...

if __name__ == "__m5_main__":
    ...
    parser.add_argument(
        "--bp",
        type=str,
        choices=list(bp_types.keys()),
        default="tournament",
        help="branch predictor to use",
    )
    ...
</code></pre>
<p>Then, let's run the test executables and learn how these BPs can impact the system performance. Among the provided executables, <code>shell_sort</code> and <code>spfa</code> are sensitive to BP, while <code>gemm</code> and <code>binary_search</code> are insensitive. In project 2, you only need to run the sensitive workloads, that is, <code>shell_sort</code> and <code>spfa</code>. So, to test the performance of local BP, the commands will look like the following:</p>
<pre><code class="language-sh"># using default CPU and Mem
build/ARM/gem5.opt -d m5out/local/sort configs/proj2/simple.py tests/labexe/shell_sort --bp local
build/ARM/gem5.opt -d m5out/local/spfa configs/proj2/simple.py tests/labexe/spfa --bp local
</code></pre>
<p>The commands to test bi-mode and tournament BPs are similar.</p>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="proj2/part1.html#admonition-tip"></a>
</div>
<div>
<p>In this project (from part 1 to 3), the <code>system.cpu.max_insts_any_thread</code> can be set to only 1e8 or 2e8 to fully exhibit the differences between tested BPs. This can save a lot of time for you.</p>
</div>
</div>
<p>After the simulations finish, let's search <code>cpu.branchPred</code> in any <code>stats.txt</code>. You may find that the branch predictors generate numerous statistic entries. However, they didn't generate basic performance metrics like <code>accuracy</code>. Thus, in this part, you are going to calculate the metric. In this project, we only concerns about the mispredict rate of <strong>conditional</strong> branches. To be short, this metric can be calculated by <code>branchPred.mispredicted_0::DirectCond / branchPred.committed_0::DirectCond</code>. The accuracy can be <code>1 - misrate</code>.</p>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="proj2/part1.html#admonition-note"></a>
</div>
<div>
<p>In <code>gem5</code>, most of the branch predictors use a shared infrastructure that contains basic components, such as BTB (branch target buffer) and RAS (return address stack). In this project, your implementation will mainly focus on predicting conditional branches, so you are not required to modify these components.</p>
</div>
</div>
<div id="admonition-delieverables" class="admonition admonish-example" role="note" aria-labelledby="admonition-delieverables-title">
<div class="admonition-title">
<div id="admonition-delieverables-title">
<p>Delieverables</p>
</div>
<a class="admonition-anchor-link" href="proj2/part1.html#admonition-delieverables"></a>
</div>
<div>
<p>Please run two BP-sensitive workloads, i.e., <code>shell_sort</code> and <code>spfa</code>, with three BPs. The rest workloads <code>gemm</code> and <code>binary_search</code>, are insensitive to BP. You can run these workloads if you are interested in, and have sufficient computing resources. Nevertheless, in this part, please (at least) include figures or tables, which show the accuracy of BPs and IPC of CPU on workloads listed below, in your <em><strong>report</strong></em>:</p>
<ul>
<li>BPs: <code>LocalBP</code>, <code>BiModeBP</code>, <code>TournamentBP</code>.</li>
<li>exe: <code>shell_sort</code>, <code>spfa</code>.</li>
<li>With default CPU and Memory (O3 and DDR4).</li>
</ul>
<p>In total, you need to run <code>gem5</code> six times.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="part-2-implement-a-simple-bp"><a class="header" href="#part-2-implement-a-simple-bp">Part 2: Implement a Simple BP</a></h1>
<p>A prediction result of a BP can be 'take', which means the branch instruction should take the branch and jump to the branch target, or 'not take', which means the branch instruction should not branch. In this part, we will build a <em>simple static branch predictor</em>, which always predicts 'take'.</p>
<p><code>gem5</code> has provided many types of BP. The source codes can be found in <code>gem5/src/cpu/pred</code>. The definitions of all BP <code>SimObject</code> can be found in <code>gem5/src/cpu/pred/BranchPredictor.py</code>, and a Python abstact class <code>BranchPredictor</code> is provided to describe basic BP structure. You can also find <code>LocalBP</code>, <code>BiModeBP</code> and <code>TournamentBP</code> in <code>BranchPredictor.py</code>. For example, <code>LocalBP</code> is defined as follows:</p>
<pre><code class="language-py">class LocalBP(BranchPredictor):
    type = "LocalBP"
    cxx_class = "gem5::branch_prediction::LocalBP"
    cxx_header = "cpu/pred/2bit_local.hh"

    localPredictorSize = Param.Unsigned(2048, "Size of local predictor")
    localCtrBits = Param.Unsigned(2, "Bits per counter")
</code></pre>
<p>Almost all <code>SimObject</code> are defined with these contents, which our simple BP will also follow:</p>
<ul>
<li><code>type</code>: the typename of this Python object.</li>
<li><code>cxx_class</code>: the typename of the C++ class that defines this object.</li>
<li><code>cxx_header</code>: the header file includes the defination of the C++ class.</li>
<li><code>&lt;name&gt; = Param.&lt;type&gt;(default, description)</code>: a list of configurable parameters, use the <code>Param</code> type provided by <code>gem5</code>.</li>
</ul>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="proj2/part2.html#admonition-note"></a>
</div>
<div>
<p>We've provided a skeleton code for you, which includes blank implementations that you need to fill when you reproduce the papers, so that the complicated <code>gem5</code> interfaces will not bother you. However, to show you the basic steps of defining a new <code>SimObject</code>, you will implement the simple BP from scratch in this part. It will be easy if you follow the tutorial below.</p>
</div>
</div>
<p>To add our simple BP, let's start with adding a new Python class to <code>BranchPredictor.py</code>, inheriting from <code>BranchPredictor</code>:</p>
<pre><code class="language-py"># src/cpu/pred/BranchPredictor.py
class SimpleBP(BranchPredictor):
    type = 'SimpleBP'
    cxx_class = 'gem5::branch_prediction::SimpleBP'
    cxx_header = 'cpu/pred/simplebp.hh'
</code></pre>
<p>Next, we need to create <code>simplebp.hh</code> and <code>simplebp.cc</code>, which contains the codes of the implementation. First, create <code>simplebp.hh</code>:</p>
<pre><code class="language-cpp">// src/cpu/pred/simplebp.hh
#ifndef __CPU_PRED_SIMPLE_BP_HH__
#define __CPU_PRED_SIMPLE_BP_HH__

#include "base/types.hh"
#include "cpu/pred/bpred_unit.hh"
#include "params/SimpleBP.hh"

namespace gem5 {
namespace branch_prediction {
class SimpleBP : public BPredUnit {
public:
  SimpleBP(const SimpleBPParams &amp;params);

  bool lookup(ThreadID tid, Addr pc, void *&amp;bp_history) override;
  void updateHistories(ThreadID tid, Addr pc, bool uncond, bool taken,
                       Addr target, void *&amp;bp_history) override;
  void update(ThreadID tid, Addr pc, bool taken, void *&amp;bp_history,
              bool squashed, const StaticInstPtr &amp;inst, Addr target) override;
  void squash(ThreadID tid, void *&amp;bp_history) override;
};
} // namespace branch_prediction
} // namespace gem5

#endif // __CPU_PRED_SIMPLE_BP_HH__
</code></pre>
<p>The definition of <code>SimpleBP</code> should be in namespace <code>gem5::branch_prediction</code>. The file should include <code>base/types.hh</code> and <code>cpu/pred/bpred_unit.hh</code> for base class definations.</p>
<p>As we described above, the Python class in <code>BranchPredictor.py</code> defines multiple configurable parameters, and <code>SimpleBP</code> inherits the parameters from <code>BranchPredictor</code> (<code>BPredUnit</code> in C++ codes). When starting the simulation, <code>gem5</code> reads these parameters from Python scripts (including the configuration scripts like we created in Project 1) and passes them to C++ classes.</p>
<p>To achieve this, SCons will automatically generate parameter headers and implementations from Python scripts, which can be included by your C++ codes. The generated codes are under <code>build/ARM/params</code>. Specifically, in code above, we firstly include <code>params/SimpleBP.hh</code>. Then, we defines a constructor with an argument <code>const SimpleBPParams &amp;params</code>.</p>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="proj2/part2.html#admonition-tip"></a>
</div>
<div>
<p>For your convenience, if you are using code editors/IDEs, you can add the special include paths of <code>gem5</code> to your tools, so that C++ code completion can work. The paths are <code>src/</code>, <code>build/ARM</code>, <code>ext/</code> and <code>ext/pybind11/include</code>.</p>
</div>
</div>
<p>Basically, the <code>params</code> will contains all parameters defined and configured in Python scripts. For example. if we defined <code>pred_result</code> in the <code>BranchPredictor.py</code>, we can use it in the constructor:</p>
<pre><code class="language-py"># BranchPredictor.py
class SimpleBP(BranchPredictor):
    type = 'SimpleBP'
    cxx_class = 'gem5::branch_prediction::SimpleBP'
    cxx_header = 'cpu/pred/simplebp.hh'

    pred_result = Param.Bool(True, "True = always take, False = always not take")
</code></pre>
<pre><code class="language-cpp">// simplebp.hh
class SimpleBP : public BPredUnit {
    ...
    bool pred_result;
};
// simplebp.cc
SimpleBP::SimpleBP(const SimpleBPParams &amp;params)
  : BPredUnit(params), pred_result(params.pred_result){}
</code></pre>
<div id="admonition-important-note" class="admonition admonish-warning" role="note" aria-labelledby="admonition-important-note-title">
<div class="admonition-title">
<div id="admonition-important-note-title">
<p>Important note</p>
</div>
<a class="admonition-anchor-link" href="proj2/part2.html#admonition-important-note"></a>
</div>
<div>
<p>Basically, the parameter passing procedure makes two constrains (for <strong><em>Python</em></strong> type <code>MyObj</code>):</p>
<ul>
<li>The included file is always <code>params/MyObj.hh</code>.</li>
<li>The parameter typename is always <code>MyObjParams</code>.</li>
</ul>
<p>If you violate these constraints, compilation will fail.
Any function signature that mismatches with base class will also fail compilation, and produce error message related to <code>MyObjParams</code> like the following:</p>
<pre><code>/gem5/ext/pybind11/include/pybind11/pybind11.h:223: undefined reference to gem5::SimpleBPParams::create() const'
collect2: error: ld returned 1 exit status
</code></pre>
<p>If you get this error, consider to double check your function signatures.</p>
</div>
</div>
<p>In addition to the parameter, we also define four methods. These methods are defined as pure-abstract methods in <code>BPredUnit</code>, which can be found in <code>bpred_unit.hh</code>. These functions should be implemented as described:</p>
<ul>
<li><code>lookup()</code> is used to predict a conditional branch. The branch is specified by its PC. All conditional branches will call this method after they are fetched to the CPU. Also, BPs may want to record useful information of a certain branch. <code>lookup()</code> gives a pointer <code>bp_history</code> to store these information. It points to <code>nullptr</code>, and you need to create an instance with the <code>new</code> operator and assign it to the <code>bp_history</code>. When the actual outcome of this branch is known, the instance will be passed back to your BP with this pointer.</li>
<li><code>updateHistories()</code> is used to update only the branch histories recorded by BP. Most of the modern BPs records the actual outcomes of previous branches as "history" (different from the word in <code>bp_history</code>) to improve the prediction. Once the outcome is known, a branch will call this method. The <code>bp_history</code> you've created in <code>lookup()</code> will be passed back. You <strong>should not</strong> delete the <code>bp_history</code>. Specifically, unconditional branches (<code>uncond==true</code>) will also call this method, but because they don't call <code>lookup()</code>, the <code>bp_history</code> will be <code>nullptr</code>. However, since they may call other methods that use <code>bp_history</code>, you need to create instances for unconditional branches in this method.</li>
<li><code>squash()</code> is used to stop an ongoing prediction, suppress BP update, and restore the BP to previous state. This may happen when an earlier branch is mispredicted, and the branch instruction of the squashed prediction will not be executed anymore. Specifically, there is a pereiod between a branch's acutal outcome is known and the branch is finally committed. <code>squash()</code> may happen in this period, when <code>updateHistories()</code> is already called. This method passes the <code>bp_history</code> you created in <code>lookup()</code> back. You need to restore BP's state from <code>bp_history</code> and delete the <code>bp_history</code>. Notice that unconditional branches that previously called <code>updateHistories()</code> may call this method, too.</li>
<li><code>update()</code> is used to update BP when the outcome (<code>taken</code>) of a branch is known, and the branch is going to be committed. If the prediction is incorrect, and causes squash of other branches, <code>update(squashed=true)</code> will be called first. Otherwise, no additional call happens. Then, under whatever condition, <code>update(squashed=false)</code> will be called to update the BP, then delete the <code>bp_history</code>.</li>
</ul>
<p>Here is a diagram that further describes the working flow of BP and these four methods under different conditions:</p>
<p><img src="proj2/./proj2part2.svg" alt="Fig" /></p>
<div id="admonition-bug" class="admonition admonish-bug" role="note" aria-labelledby="admonition-bug-title">
<div class="admonition-title">
<div id="admonition-bug-title">
<p>Bug</p>
</div>
<a class="admonition-anchor-link" href="proj2/part2.html#admonition-bug"></a>
</div>
<div>
<p>Here are some known bugs in <code>gem5</code> that make the behavior violates the descriptions above:</p>
<ul>
<li>It is claimed that all conditional branches call <code>lookup()</code> firstly and <code>update()</code> finally. However, the first few branches may directly call <code>update()</code>, and pass an uninitialized <code>bp_history</code>.</li>
<li>When a branch is mispredicted and cause squash of other branches, it will call <code>update()</code> twice, <code>update(squashed=true)</code> then <code>update(squashed=false)</code>. We expect the <code>bp_history</code> in these two calls are the same. However, some branches pass different <code>bp_history</code>.</li>
</ul>
<p>The frequency of these events is below 0.1%, so they won't impact the performance of your BPs, but may cause fatal errors if you don't check the <code>bp_history</code>. One way to avoid fatal errors is to record a magic number in your <code>bp_history</code> and check it before you use them.</p>
</div>
</div>
<p>These descriptions may be hard to understand. When you are implementing a "not simple" BP, you can learn the basic implementation principles of these functions from <code>bimode.cc</code> or <code>tournament.cc</code>. However, in <code>SimpleBP</code>, we do not care about any history or BP state. The implementation in <code>simplebp.cc</code> will be the simplest. We just return <code>true</code> in <code>lookup()</code>, and leave blank implementations in other functions:</p>
<pre><code class="language-cpp">// src/cpu/pred/simplebp.cc
#include "cpu/pred/simplebp.hh"

namespace gem5 {
namespace branch_prediction {
SimpleBP::SimpleBP(const SimpleBPParams &amp;params) : BPredUnit(params) {}

bool SimpleBP::lookup(ThreadID tid, Addr pc, void *&amp;bp_history) { return true; }
void SimpleBP::updateHistories(ThreadID tid, Addr pc, bool uncond, bool taken,
                               Addr target, void *&amp;bp_history) {}

void SimpleBP::update(ThreadID tid, Addr pc, bool taken, void *&amp;bp_history,
                      bool squashed, const StaticInstPtr &amp;inst, Addr target) {}
void SimpleBP::squash(ThreadID tid, void *&amp;bp_history) {}
} // namespace branch_prediction
} // namespace gem5
</code></pre>
<p>Now we've finished the C++ implementation, the next thing we need to do is to register <code>SimpleBP</code> in the SCons script to let it be compiled. In <code>cpu/pred/SConscript</code>, we need to add <code>SimpleBP</code> to the list of <code>SimObject</code>, and register the source code <code>simplebp.cc</code>:</p>
<pre><code class="language-py"># src/cpu/pred/SConscript
SimObject('BranchPredictor.py',
    sim_objects=[
    # add this
    'SimpleBP',
    ...])

# add this
Source('simplebp.cc')
...
</code></pre>
<p>Finally, we configure the CPU with our <code>SimpleBP</code> in the configuration script:</p>
<pre><code class="language-py"># configs/proj2/simple.py
bp_types = {
    ...
    "simple": SimpleBP,
}
</code></pre>
<p>And we can compile and run the <code>gem5</code>:</p>
<pre><code class="language-sh">scons build/ARM/gem5.opt -j $(nproc)
build/ARM/gem5.opt configs/proj2/simple.py tests/labexe/hello --bp simple
</code></pre>
<p>If everything goes correctly, we can see the <code>cpu.branchPred</code> has changed in <code>config.ini</code>.</p>
<div id="admonition-important-note-1" class="admonition admonish-warning" role="note" aria-labelledby="admonition-important-note-1-title">
<div class="admonition-title">
<div id="admonition-important-note-1-title">
<p>Important note</p>
</div>
<a class="admonition-anchor-link" href="proj2/part2.html#admonition-important-note-1"></a>
</div>
<div>
<p>You may have noticed that the SCons again generates a lot of outputs while compiling. This is because we've modified <code>BranchPredictor.py</code>, and SCons needs to re-generate the py-cpp binding codes. Actually, any modification to Python scripts under <code>src</code> will cause SCons to re-generate all binding codes, which takes very long time. So when you are implementing other new components, try to design all the required parameters first, and modify Python scripts only once to save compile time.</p>
</div>
</div>
<div id="admonition-delieverables" class="admonition admonish-example" role="note" aria-labelledby="admonition-delieverables-title">
<div class="admonition-title">
<div id="admonition-delieverables-title">
<p>Delieverables</p>
</div>
<a class="admonition-anchor-link" href="proj2/part2.html#admonition-delieverables"></a>
</div>
<div>
<p>Please run two BP-sensitive workloads, i.e., <code>shell_sort</code> and <code>spfa</code>, with your <code>SimpleBP</code>. In this part, please (at least) include figures or tables, which show the accuracy of <code>SimpleBP</code> and IPC of CPU on workloads listed below, in your <em><strong>report</strong></em>:</p>
<ul>
<li>BPs: <code>SimpleBP</code>.</li>
<li>exe: <code>shell_sort</code>, <code>spfa</code>.</li>
<li>With default CPU and Memory (O3 and DDR4).</li>
</ul>
<p>In total, you need to run <code>gem5</code> twice.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="part-3-read-paper-implement-and-evaluate-perceptron-bp"><a class="header" href="#part-3-read-paper-implement-and-evaluate-perceptron-bp">Part 3: Read Paper, Implement and Evaluate Perceptron BP</a></h1>
<h2 id="a-brief-introduction-to-2-bit-local-bp-and-gshare-predictor"><a class="header" href="#a-brief-introduction-to-2-bit-local-bp-and-gshare-predictor">A brief introduction to 2-bit local BP and GShare predictor</a></h2>
<p>Before introducing perceptron BP, we first describe two basic branch predictors, i.e., the <strong>2-bit local BP</strong> and the <strong>GShare predictor</strong>.</p>
<p><img src="proj2/./proj2part3.svg" alt="Fig" /></p>
<p>As shown in Fig (a) above, the 2-bit local BP contains a saturating counter table. When a branch instruction is executed, the BP indexes into the counter table based on the instruction’s PC. The BP predicts 'take' if the counter is 2 (<code>10</code>) or 3 (<code>11</code>), and 'not take' otherwise. When the actual branch outcome is known, the counter in the saturating counter table will be updated. The counter is increased by 1 (will not exceed 3) if the actual outcome is 'taken', and vice versa.</p>
<p>Note that the behavior of one branch is usually correlated to the behavior of the most recent branches. However, a predictor that uses the behavior of only a single branch to predict (e.g., 2-bit BP) can never capture this feature. To be aware of the most recent branches (i.e., branch <strong>history</strong> pattern), the GShare predictor proposes to add a global history register (GHR) to the BP as shown in Fig (b) above. The GHR records the history of each most recent branch instruction <strong>with a single bit</strong> and updates itself when an actual branch outcome is known. The GHR has a <strong>fixed bit length</strong>, and when it updates, it will <strong>shift by one bit</strong> to remove the earliest history from it. Consequently, the updating is similar to <code>GHR &lt;&lt;= 1; GHR |= outcome (1 if taken, else 0)</code>. Further, when indexing into the counter table, the PC is first hashed (i.e., XOR) with GHR, thus the history information is taken into consideration. It is also possible to replace GHR with a table of local history registers (LHRs), which will be indexed by PC. More information about these branch predictors can be found in this <a href="https://zhuanlan.zhihu.com/p/602635898">blog</a>.</p>
<h2 id="a-brief-introduction-to-perceptron-bp"><a class="header" href="#a-brief-introduction-to-perceptron-bp">A brief introduction to perceptron BP</a></h2>
<p>Now, we introduce the simple perceptron BP, which is first described in the paper.</p>
<div id="admonition-cite" class="admonition admonish-quote" role="note" aria-labelledby="admonition-cite-title">
<div class="admonition-title">
<div id="admonition-cite-title">
<p>Cite</p>
</div>
<a class="admonition-anchor-link" href="proj2/part3.html#admonition-cite"></a>
</div>
<div>
<p>Jiménez, Daniel A. and Calvin Lin. “Dynamic branch prediction with perceptrons.” Proceedings HPCA Seventh International Symposium on High-Performance Computer Architecture (2001): 197-206.</p>
<p><a href="https://www.cs.utexas.edu/~lin/papers/hpca01.pdf">get the pdf</a></p>
</div>
</div>
<p>The simple perceptron BP replaces the 2-bit counters with perceptrons. A perceptron is a vector of signed integers, i.e., its weights. When predicts, the BP computes the <strong>dot product</strong> of the weight vector and GHR (regard the bits as integers, and '0' as '-1'), instead of checking the saturating counter. If the dot product is non-negative, the BP predicts 'take', and vice versa.</p>
<p>The BP updates the perceptron with a 'training' method when an actual branch outcome is known. The weights will be increased or decreased by 1 according to the GHR history, the prediction correctness and the actual outcome. The BP also has a threshold for the weights. If the absolute value of the dot product reaches the threshold, the BP will not further train the perceptron if its prediction is correct.</p>
<h2 id="reading-the-paper-and-implementing-perceptron-bp"><a class="header" href="#reading-the-paper-and-implementing-perceptron-bp">Reading the paper and implementing perceptron BP</a></h2>
<p>In this part, you are required to read the paper listed above, summarize the method described in the paper, and implement the perceptron BP in <code>gem5</code>. For your convenience, an Appendix provides a brief description of the method. We've already provided a code skeleton. Please check <code>Lab2PerceptronBP</code> in <code>BranchPredictor.py</code>, <code>cpu/pred/lab2_bp.hh</code> and <code>cpu/pred/lab2_bp.cc</code>. You can follow the tutorial in part 2 to add useful parameters to <code>Lab2PerceptronBP</code> and implement C++ codes.</p>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="proj2/part3.html#admonition-tip"></a>
</div>
<div>
<p>If you cannot figure out how to implement, you can check the implementation of <code>BiModeBP</code> and <code>TournamentBP</code>. They are simple enough, and include all necessary steps to implement a global-history-aware BP in <code>gem5</code>.</p>
</div>
</div>
<div id="admonition-delieverables" class="admonition admonish-example" role="note" aria-labelledby="admonition-delieverables-title">
<div class="admonition-title">
<div id="admonition-delieverables-title">
<p>Delieverables</p>
</div>
<a class="admonition-anchor-link" href="proj2/part3.html#admonition-delieverables"></a>
</div>
<div>
<p>Please run two BP-sensitive workloads, i.e., <code>shell_sort</code> and <code>spfa</code>, with your <code>LabPerceptronBP</code>. In this part, please (at least) include figures or tables, which show the accuracy of <code>Lab2PerceptronBP</code> and IPC of CPU on executables listed below, in your <em><strong>report</strong></em>:</p>
<ul>
<li>BPs: <code>Lab2PerceptronBP</code>.</li>
<li>exe: <code>shell_sort</code>, <code>spfa</code>.</li>
<li>With default CPU and Memory (O3 and DDR4).</li>
</ul>
<p>You are encouraged to try different parameters, including perceptron threshold, number of perceptrons, and GHR length. However, since running multiple epoches to adjust parameters may take tremendous time, it's ok for you to simply try a set of default parameters. Thus, at lease you need to run <code>gem5</code> twice.</p>
<p>In this part, you also need to submit:</p>
<ul>
<li><em><strong>your codes</strong></em>, including <code>BranchPredictor.py</code>, <code>lab2_bp.hh</code> and <code>lab2_bp.cc</code>.</li>
<li><em><strong>paper summary</strong></em>, which summarizes the cited paper, including motivations, challenges and designs.</li>
</ul>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="part-4-optimize-a-program-segment-using-branch-optimization-techniques"><a class="header" href="#part-4-optimize-a-program-segment-using-branch-optimization-techniques">Part 4: Optimize a Program Segment Using Branch Optimization Techniques</a></h1>
<p>It is well known that branch instructions cause pauses, significantly impacting program performance. To address this issue, hardware manufacturers have developed various branch predictors that reduce pauses by anticipating branches in advance. So, as software developers, can we further optimize program performance at the software level by understanding these branch predictors? The answer is yes.</p>
<p>In this experiment, we also hope students will gain an initial understanding of how branch optimization enhances program efficiency and appreciate its unique appeal. While compilers may already implement some optimization techniques, we still encourage students to delve into the principles behind these techniques through hands-on practice, thereby gaining a deeper understanding of the importance of branches in CPU architecture.</p>
<h2 id="lab-setup-preparation"><a class="header" href="#lab-setup-preparation">Lab Setup Preparation</a></h2>
<p>We need to obtain three files from <a href="https://disk.pku.edu.cn/link/AA8F735492EA4048A282AA5A7B9820B521">PKU Disk</a> or the <a href="https://course.pku.edu.cn/">teaching and learning network</a> for this part of the experiment. These files are <code>branch_optimize.c</code>, <code>branch_optimize_gen.cc</code>, and <code>branch_optimize.h</code>, which we will place in the <code>tests/labexe/</code>. The specific directory structure is shown in the diagram below:</p>
<pre><code class="language-sh">gem5-root
    |
    |---tests
          |
          |---labexe
                |
                |---branch_optimize.c
                |---branch_optimize_gen.cc
                |---branch_optimize.h
</code></pre>
<p>At the same time, we need to modify the <code>tests/labexe/makefile</code> file to support the normal compilation of these newly added files:</p>
<pre><code class="language-makefile">...
# tests/labexe/makefile
# DELETE: TGT = shell_sort gemm binary_search spfa
TGT = shell_sort gemm binary_search spfa branch_optimize # ADD
...
lz77_args = 1000000
branch_optimize_args = 500000 # ADD
...
</code></pre>
<p>You can enter <code>make -j $(nproc)</code> in directory <code>/gem5/tests/labexe/</code> to compile the target program after modifying it. The generated binary file will be located in <code>tests/labexe/branch_optimize</code>.</p>
<h2 id="our-goal"><a class="header" href="#our-goal">Our Goal</a></h2>
<p>In this part, we generated a fictional weather database, with each entry defined as follows:</p>
<pre><code class="language-c">typedef struct WeatherData {
    int year;
    int month;
    int day;
    int temperature;
    enum WeatherCondition condition;
    enum City city;
    float humidity;
    float windSpeed;
    int is_scanned;
} WeatherData;
</code></pre>
<p>The city and weather fields utilize enumeration types, defined as follows:</p>
<pre><code class="language-c">enum WeatherCondition {
    SUNNY = 0002,
    CLOUDY = 1009,
    RAINY = 1511,
    STORMY = 3011,
    SNOWY = 4003
};

enum City {
    NEW_YORK = 1,
    LOS_ANGELES = 2,
    CHICAGO = 3,
    HOUSTON = 4,
    MIAMI = 5
};
</code></pre>
<p>We need to optimize a target program for processing this weather data. The program's primary functions are:</p>
<ul>
<li>Exclude entries with outliers from all subsequent statistical calculations</li>
<li>Count the number of data entries for the period from 2012 to 2024</li>
<li>Count the number of data entries for the period from June to August</li>
<li>Count the number of data entries for each city</li>
<li>Count the frequency of occurrence for each type of weather</li>
<li>Count the frequency of occurrence for each wind force category, grouping those above force 10 into a single category</li>
<li>Record the minimum and maximum temperatures observed across all entries</li>
<li>Record the absolute maximum temperature value</li>
<li>Count the frequency of humidity levels below 50%</li>
<li>Count the frequency of temperatures exceeding 30 degrees Celsius</li>
<li>Mark the entry as scanned</li>
</ul>
<p>In <code>tests/labexe/branch_optimize.c</code>, we present a straightforward approach that does not achieve optimal performance. Students can optimize this performance by modifying the code in the designed area.</p>
<pre><code class="language-c">|        NO MODIFICATINS ALLOWED         |
/*   START position of editable area    */
|                 ...                    |
|            EDITABLE AREA               |
|                 ...                    |
/*    END position of editable area     */
|        NO MODIFICATINS ALLOWED         |
</code></pre>
<p>The following requirements apply during this process:</p>
<ul>
<li>Multithreading or multiprocessing is not permitted</li>
<li>No libraries import (via <code>#include</code>)</li>
<li>Parallel commands such as vectorization are prohibited</li>
<li><strong>NO loop unrolling technique</strong></li>
<li>The original program semantics must not be altered</li>
</ul>
<h2 id="test"><a class="header" href="#test">Test</a></h2>
<p>After modifying the code at the specified area, run the following command at <code>tests/labexe/branch_optimize</code> to compile the binary file:</p>
<pre><code class="language-sh">make -j $(nproc)
</code></pre>
<p>Next, you can execute the following command at <code>gem5/</code> to test the code's performance:</p>
<pre><code class="language-sh">build/ARM/gem5.opt configs/proj2/simple.py tests/labexe/branch_optimize --bp local --cpu o3 --mem DDR4
</code></pre>
<p>You can evaluate the actual runtime of your code using the <code>simSeconds</code> in the <code>stat.txt</code> file output by <code>gem5</code>. <strong>Our performance evaluation is also based on this metric</strong>.</p>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="proj2/part4.html#admonition-note"></a>
</div>
<div>
<p>In this part, the <code>system.cpu.max_insts_any_thread</code> should be set 5e8.</p>
</div>
</div>
<div id="admonition-tip" class="admonition admonish-tip" role="note" aria-labelledby="admonition-tip-title">
<div class="admonition-title">
<div id="admonition-tip-title">
<p>Tip</p>
</div>
<a class="admonition-anchor-link" href="proj2/part4.html#admonition-tip"></a>
</div>
<div>
<p>Our performance test consists of <em><strong>a single test case</strong></em> generated from <code>tests/labexe/branch_optimize_gen.cc</code>, which can be vviewed in the <code>tests/labexe/branch_optimize.in</code>.</p>
</div>
</div>
<div id="admonition-delieverables" class="admonition admonish-example" role="note" aria-labelledby="admonition-delieverables-title">
<div class="admonition-title">
<div id="admonition-delieverables-title">
<p>Delieverables</p>
</div>
<a class="admonition-anchor-link" href="proj2/part4.html#admonition-delieverables"></a>
</div>
<div>
<p>Please run our target workloads, <code>branch_optimize</code>, with <code>LocalBP</code>. In this part, please (at least) include figures or tables, which show the actual runtime of <code>branch_optimize</code> and IPC of CPU on executables listed below, in your <em><strong>report</strong></em>:</p>
<ul>
<li>BPs: <code>LocalBP</code>.</li>
<li>exe: <code>branch_optimize</code>.</li>
<li>With default CPU and Memory (O3 and DDR4).</li>
</ul>
<p>In this part, you also need to submit:</p>
<ul>
<li><em><strong>your codes</strong></em>, including <code>branch_optimize.c</code>.</li>
<li><em><strong>technical introduction</strong></em>, which analyzes the optimization techniques used in your code and explain why they improve performance. (Unexplained code or techniques are permitted, but they should constitute <em><strong>less than 50%</strong></em> of the total.)</li>
</ul>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="submission"><a class="header" href="#submission">Submission</a></h1>
<div id="admonition-submission" class="admonition admonish-note" role="note" aria-labelledby="admonition-submission-title">
<div class="admonition-title">
<div id="admonition-submission-title">
<p>Submission</p>
</div>
<a class="admonition-anchor-link" href="proj2/submit.html#admonition-submission"></a>
</div>
<div>
<ul>
<li>Please submit the deliverables for each part in order and clearly defined in a report form (e.g., PDF or Word). Please give a brief description of the results in your report. You also <strong>NEED</strong> to submit your codes, technical introduction and paper summary.</li>
<li>Please pack your report, codes, technical introduction and summary in an archive and submit it as an attachment at <a href="https://course.pku.edu.cn">course.pku.edu.cn</a>. The title of the attachment should be Student-ID_Name_Proj2 (e.g., 123456789_WangXiaoming_Proj2).</li>
<li>You can also send the archive to <a href="proj2/">2501112042@stu.pku.edu.cn</a>. The titles of your email AND attachment should both be Student-ID_Name_Proj2.</li>
<li><strong>DO NOT PLAGIARIZE</strong>. We will select 10 students randomly and ask them to answer our questions related to their results.</li>
</ul>
</div>
</div>
<div id="admonition-late-policy" class="admonition admonish-warning" role="note" aria-labelledby="admonition-late-policy-title">
<div class="admonition-title">
<div id="admonition-late-policy-title">
<p>Late policy</p>
</div>
<a class="admonition-anchor-link" href="proj2/submit.html#admonition-late-policy"></a>
</div>
<div>
<ul>
<li>You will be given <strong>3 slip days</strong> (shared by all projects), which can be used to extend project deadlines, e.g., 1 project extended by 3 days or 3 projects each extended by 1 day.</li>
<li>Projects are due at 23:59:59, no exceptions; 20% off per day late, 1 second late = 1 hour late = 1 day late.</li>
</ul>
</div>
</div>
<div id="admonition-deliverables" class="admonition admonish-example" role="note" aria-labelledby="admonition-deliverables-title">
<div class="admonition-title">
<div id="admonition-deliverables-title">
<p>Deliverables</p>
</div>
<a class="admonition-anchor-link" href="proj2/submit.html#admonition-deliverables"></a>
</div>
<div>
<p>You need to submit <em><strong>report</strong></em>, <em><strong>codes</strong></em>, <em><strong>technical introduction</strong></em> and <em><strong>paper summary</strong></em> in this project. The required contents are listed as follows:</p>
<ul>
<li>report:</li>
<li>
<ul>
<li>Figures and tables which show the BP accuracy and CPU IPC of following BPs on <code>shell_sort</code> and <code>spfa</code>: <code>LocalBP</code>, <code>BiModeBP</code>, <code>TournamentBP</code>, <code>SimpleBP</code>, <code>Lab2PerceptronBP</code>. Please run with <code>O3CPU</code> and <code>DDR4</code> memory.</li>
</ul>
</li>
<li>codes:</li>
<li>
<ul>
<li>Your implementation, i.e., <code>BranchPredictor.py</code>, <code>lab2_bp.hh</code>, <code>branch_optimize.c</code> and <code>lab2_bp.cc</code>.</li>
</ul>
</li>
<li>summary:</li>
<li>
<ul>
<li>A summary of the cited paper including motivations, challenges and designs.</li>
</ul>
</li>
<li>technical introduction:</li>
<li>
<ul>
<li>A report of the optimization techniques used in your code and explanation why they improve performance. (Unexplained code or techniques are permitted, but they should constitute <em><strong>less than 50%</strong></em> of the total.)</li>
</ul>
</li>
</ul>
<p>Please pack all files in an archive and submit the archive.</p>
</div>
</div>
<div id="admonition-grading" class="admonition admonish-success" role="note" aria-labelledby="admonition-grading-title">
<div class="admonition-title">
<div id="admonition-grading-title">
<p>Grading</p>
</div>
<a class="admonition-anchor-link" href="proj2/submit.html#admonition-grading"></a>
</div>
<div>
<p>In this project, the grading is partially based on the performance of your implementation. The details are (15 points in total):</p>
<ul>
<li>Resonable performance statistics of <code>LocalBP</code>, <code>BiModeBP</code> and <code>TournamentBP</code>:</li>
<li>
<ul>
<li><strong>3pts</strong>.</li>
</ul>
</li>
<li><em><strong>PLUS</strong></em> reasonable performance statistics of <code>SimpleBP</code>:</li>
<li>
<ul>
<li><strong>4pts</strong>.</li>
</ul>
</li>
<li><em><strong>PLUS</strong></em> a compilable perceptron BP implementation:</li>
<li>
<ul>
<li><strong>7pts</strong>.</li>
</ul>
</li>
<li><em><strong>PLUS</strong></em> a comparable performance with <code>LocalBP</code> of your perceptron BP:</li>
<li>
<ul>
<li><strong>11pts</strong>.</li>
</ul>
</li>
<li><em><strong>PLUS</strong></em> a comparable performance with <code>BiModeBP</code> or <code>TournamentBP</code> of your perceptron BP:</li>
<li>
<ul>
<li><strong>13pts</strong>.</li>
</ul>
</li>
<li><em><strong>PLUS</strong></em> reasonable performance improvements (minimum 7%) and corresponding technical explanations:</li>
<li>
<ul>
<li><strong>15pts</strong>.</li>
</ul>
</li>
</ul>
<p>There are additional <strong>5pts</strong> based on your paper summary. A comprehensive summary including motivations, challenges and designs will get 5pts. Lack of any single part will cause <strong>-1pt</strong>.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="appendix-perceptron-bp-method-brief-description"><a class="header" href="#appendix-perceptron-bp-method-brief-description">Appendix: Perceptron BP Method Brief Description</a></h1>
<p>The overall structure of a perceptron BP is shown below:</p>
<p><img src="proj2/./proj2append.svg" alt="Fig" /></p>
<p>The Select Entry step is to hash the PC. The hash can be XORing PC with the GHR or other methods. Each perceptron is a vector of weight <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, and each weight is a signed integer. When predicts, the BP computes:
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>
where the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the bias, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> is the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>-th bit of GHR (value '0' is regarded as '-1' when multiply). If <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>, the prediction will be 'take', and vice versa. When the actual branch outcome is known, the perceptron that is used to predict this branch is trained with the following method:</p>
<div id="admonition-default" class="admonition admonish-quote" role="note">
<div>
<p><strong>if</strong> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> <strong>or</strong> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ab</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></p>
<p>  <strong>for</strong> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> <strong>in</strong> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0..</span><span class="mord mathnormal">n</span></span></span></span> # also update bias</p>
<p>    <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">+</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p>
<p>  <strong>end for</strong></p>
<p><strong>end if</strong></p>
</div>
</div>
<p>where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> is the actual outcome, set <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> for 'taken' and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">1</span></span></span></span> for 'not taken'. <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span> is the threshold.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>


    </div>
    </body>
</html>
