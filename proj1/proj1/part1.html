<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Part 1: Create and Run a Simple Configuration Script - Archlab gem5 Project 1</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Archlab gem5 Project 1</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="part-1-create-and-run-a-simple-configuration-script"><a class="header" href="#part-1-create-and-run-a-simple-configuration-script">Part 1: Create and Run a Simple Configuration Script</a></h1>
<p><code>gem5</code> simulator is built from a collection of Python objects, <code>SimObject</code>. In this part, you need to set up a simple configuration script to describe the <code>SimObject</code> to be instantiated, their parameters, and their relationships. Following the instructions in this part, you are able to model a simple computer system, including a simple CPU core, a single DDR4 memory channel, and a system-wide memory bus connecting CPU core and memory channel.</p>
<p>Let’s get started by creating a new configuration file:</p>
<pre><code class="language-sh">mkdir configs/proj1
touch configs/proj1/simple.py
</code></pre>
<p>This configuration file is a normal Python file. Therefore, you can use any legal grammar or available libraries in Python.</p>
<p>The first thing we should write in the script is to import the class definitions from the <code>m5</code> modules and all <code>SimObject</code> as follows:</p>
<pre><code>import m5
from m5.objects import *
</code></pre>
<div id="admonition-info" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-title">
<div class="admonition-title">
<div id="admonition-info-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="#admonition-info"></a>
</div>
<div>
<p><code>gem5</code> is an open-source project based on another project <code>m5</code>, which is still involved in <code>gem5</code> from many aspects.</p>
</div>
</div>
<p>In <code>gem5</code>, to simplify the description of large systems, the overall simulation specification is organized as a tree. Each node in the tree is a <code>SimObject</code> instance. The program must create a special object root of class <code>Root</code> to identify the root of the tree hierarchy. When parsing the configuration program, the tree hierarchy is walked recursively to identify the objects from the root to its descendants. We will create the first object which is the <code>Root</code> and specify its parameters in the “m5 main process”:</p>
<pre><code class="language-python">if __name__ == '__m5_main__':
    root = Root()
    root.full_system = False
    root.system = System()
</code></pre>
<p><code>gem5</code> provides two simulation modes: system call emulation (SE) mode and full system (FS) mode. In FS mode, Gem5 can simulate a complete system with devices and an operating system, while in SE mode, only essential system services are provided by simulator to execute workloads. In our projects, we will use SE mode for faster simulation (<code>root.full_system = False</code>). The above codes also instantiate class <code>System</code>. It is the parent of all the other objects in the simulated system, and contains a lot of functional information, such as the physical memory ranges, the root clock domain, the root voltage domain, etc.</p>
<div id="admonition-note" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-title">
<div class="admonition-title">
<div id="admonition-note-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="#admonition-note"></a>
</div>
<div>
<p>Here is an alternative method to pass the parameters as named arguments:</p>
<pre><code class="language-python">root = Root(full_system = False, system = System())
</code></pre>
<p>All the definitions of the used Python objects can be found under <code>gem5/src/.../*.py</code>. For example, <code>Root</code> can be found in <code>gem5/src/sim/Root.py</code>. You can check the usages of objects and choose your favorite way.</p>
</div>
</div>
<p>Now that a reference to the system for the simulation has been created, let’s build a simple but complete system. The first thing is to set the clock on the system. We first need to create the clock domain, which is an instance of class <code>SrcCLockDomain</code>. Clock domain contains multiple parameters such as clock (clock frequency), voltage domain (voltage), etc. Each parameter has its default value defined in the python class. We can also manually set the values in the configuration script as follows:</p>
<pre><code class="language-python">def init_system(system):
    system.clk_domain = SrcClockDomain(clock='4GHz', voltage_domain=VoltageDomain())
</code></pre>
<p>Once the clock domain is set up, we can move to create the memory and the memory controller. We need to configure the memory simulation mode and memory range. Since we make configurations for normal simulation, we are going to select <em>timing mode</em> for the memory simulation, which can be applied in most conditions. In other simulation conditions such as restoring memory system from a checkpoint, you may select <em>atomic mode</em>.</p>
<p>Then, we will also set up a single memory range of size 2GB and assign it to the system. We should also get instances of memory controller (<code>MemCtrl</code>) and memory device from various memory device classes such as DDR4 DRAM (<code>DDR4_2400_8x8</code>), HMC (<code>HMC_2500_x32</code>), etc. All available memory devices classes are listed in <code>src/mem/DRAMInterface.py</code>. Last, we assign the memory device with the memory range.</p>
<pre><code class="language-python">system.mem_mode = 'timing'
system.mem_ranges = [AddrRange ('2GB')]
system.mem_ctrl = MemCtrl()
system.mem_ctrl.dram = DDR4_2400_8x8()
system.mem_ctrl.dram.range = root.system.mem_ranges[0]
</code></pre>
<p>So far, we have almost completed memory setup. Now, we can create a CPU. <code>gem5</code> provides various types of CPU such as <code>SimpleCPU</code> (simplified CPU timing model), <code>MinorCPU</code> (in-order CPU), <code>O3CPU</code> (out-of-order CPU), etc. As an example, we choose simple timing-based CPU in Gem5, <code>TimingSimpleCPU</code>. This CPU model executes each instruction in a single clock cycle, except for memory requests, which flow through the memory. You can instantiate the object in the system:</p>
<pre><code class="language-python">system.cpu = TimingSimpleCPU()
</code></pre>
<p>Next, we need to create a system bus to connect between the CPU and memory controller. The command to instantiate memory bus is as follows:</p>
<pre><code class="language-python">system.membus = SystemXBar()
</code></pre>
<p>Now that we have created the system bus, the next step is to describe the interconnect logic which actually connect the CPU to the memory. For CPU, we need to connect the ICache and DCache ports to the system bus (currently we do not include any cache in the CPU). For memory, we need to connect memory controller port to the system bus. In addition, we need to create an interrupt controller on the CPU and connect a system port to the memory bus. This port is a functional-only port to allow the system to read/write memory:</p>
<pre><code class="language-python">system.cpu.icache_port = system.membus.cpu_side_ports
system.cpu.dcache_port = system.membus.cpu_side_ports
system.mem_ctrl.port = system.membus.mem_side_ports
system.cpu.createInterruptController()
system.system_port = system.membus.cpu_side_ports
# system.cpu.interrupts[0].pio = system.membus.mem_side_ports
# system.cpu.interrupts[0].int_requestor = system.membus.cpu_side_ports
# system.cpu.interrupts[0].int_responder = system.membus.mem_side_ports
</code></pre>
<div id="admonition-info-1" class="admonition admonish-info" role="note" aria-labelledby="admonition-info-1-title">
<div class="admonition-title">
<div id="admonition-info-1-title">
<p>Info</p>
</div>
<a class="admonition-anchor-link" href="#admonition-info-1"></a>
</div>
<div>
<p>For your information, X86 ISA also requires connecting PIO and interrupt ports to the memory bus. Here we use ARM ISA and ignore these requirements, but we leave the code in comments.</p>
</div>
</div>
<div id="admonition-note-1" class="admonition admonish-note" role="note" aria-labelledby="admonition-note-1-title">
<div class="admonition-title">
<div id="admonition-note-1-title">
<p>Note</p>
</div>
<a class="admonition-anchor-link" href="#admonition-note-1"></a>
</div>
<div>
<p>In code above, we manually connect all the necessary ports of CPU to show the details of system wiring up. In fact, <code>gem5</code> source codes have provided a wrapped helper function to perform this procedure. You can use it as follows:</p>
<pre><code class="language-python">system.cpu.connectBus(system.membus)
system.mem_ctrl.port = system.membus.mem_side_ports
system.cpu.createInterruptController()
system.system_port = system.membus.cpu_side_ports
</code></pre>
</div>
</div>
<p>So far, we have finished the configuration of simulated system. Next, we will set up the program to be executed. <code>gem5</code> allows you to specify any application built for ARM ISA and that’s been <strong>statically</strong> compiled. In this script, we will execute a simple “Hello World” program. You can compile the code with <code>make</code> in <code>tests/labexe</code>, or download the pre-built binaries from <a href="https://disk.pku.edu.cn/link/AA8F735492EA4048A282AA5A7B9820B521">PKU Disk</a>.</p>
<div id="admonition-important-note" class="admonition admonish-warning" role="note" aria-labelledby="admonition-important-note-title">
<div class="admonition-title">
<div id="admonition-important-note-title">
<p>Important note</p>
</div>
<a class="admonition-anchor-link" href="#admonition-important-note"></a>
</div>
<div>
<p>In our released codes, we've included five simple but representative algorithm programs in <code>gem5/tests/labexe</code>. The Docker image also includes the cross-compile toolchain. To compile these programs, simply run following commands:</p>
<pre><code class="language-sh">cd tests/labexe
make
</code></pre>
<p>Then the executable files can be found under <code>tests/labexe</code>.</p>
<p>If you want to compile your own programs, just use <code>arm-linux-gnueabihf-gcc</code> and <code>arm-linux-gnueabihf-g++</code> as the compiler. Remember to add <code>-static</code> option so that <code>gem5</code> can correctly load the executables.</p>
<p>If you are not using Docker and want to compile ARM executables, you should install the cross-compile toolchain:</p>
<pre><code class="language-sh">sudo apt install gcc-arm-linux-gnueabihf
</code></pre>
<p>If you prefer not to build the excutables by yourself or the building process takes a lot of time, you can just download the pre-built binaries from <a href="https://disk.pku.edu.cn/link/AA8F735492EA4048A282AA5A7B9820B521">PKU Disk</a>.</p>
</div>
</div>
<p>To inform <code>gem5</code> to execute our program, we first need to set system workload to the executable. Then we create a process and set the process command to the workload we want to run. This is a list structure with the executable in the first field and the arguments passed to the executable in the rest of the list. Then we configure the CPU to execute the process and finally create the functional execution contexts in the CPU:</p>
<pre><code class="language-python">import os
def init_process(root):
    exe_path = 'tests/labexe/hello'
    root.system.workload = SEWorkload.init_compatible(exe_path)
    process = Process()
    process.executable = exe_path
    process.cwd = os.getcwd()
    process.cmd = [exe_path]
    root.system.cpu.workload = process
    root.system.cpu.createThreads()
</code></pre>
<p>Finally, we need to instantiate the object hierarchy by calling <code>instantiate()</code> function. Once the object hierarchy has been instantiated, the actual simulation can begin. The <code>simulate()</code> function invokes the C++ event loop. By default, this function will simulate forever, or until some other factor causes the simulation loop to exit (such as the CPU has been shutdown). If a positive integer argument is passed to the simulate function, it will simulate at most that number of additional ticks, but may exit sooner if another cause arises first. In any case, the <code>simulate()</code> function will return an event object that represents the reason for exiting. The object can be queried via its <code>getCause()</code> method for a string explaining that reason. Let’s return to m5 main process, initialize the system and process, then start the simulation:</p>
<pre><code class="language-python">if __name__ == '__m5_main__':
    root = Root()
    root.full_system = False
    root.system = System()
    # new codes:
    init_system(root.system)
    init_process(root)
    m5.instantiate()
    exit_event = m5.simulate()
    print(f'{exit_event.getCause()} ({exit_event.getCode()}) @ {m5.curTick()}')
</code></pre>
<p>Now, we have created a simple but complete simulation script, we are ready to run <code>gem5</code>:</p>
<pre><code class="language-sh">build/ARM/gem5.opt configs/proj1/simple.py
</code></pre>
<p>If everything goes fine, you'll see contents like follows:</p>
<pre><code>...
Hello, World!
exiting with last active thread context (0) @ 14307750
</code></pre>
<div id="admonition-deliverables" class="admonition admonish-example" role="note" aria-labelledby="admonition-deliverables-title">
<div class="admonition-title">
<div id="admonition-deliverables-title">
<p>Deliverables</p>
</div>
<a class="admonition-anchor-link" href="#admonition-deliverables"></a>
</div>
<div>
<p>Please include a <strong>screenshot of the output on stdout of your configuration script</strong> in your <em><strong>report</strong></em>.</p>
</div>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../proj1/setup.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../proj1/part2.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../proj1/setup.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../proj1/part2.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
